# 头脑风暴系统实现文档 (MVP)

本文档详细描述了头脑风暴系统MVP的实现细节，以指导开发工作。MVP版本将使用shell作为运行环境，且暂不实现用户对讨论的中途介入功能。

## 系统架构

### 核心组件

- **主控制器**：负责整个流程的协调，通过LLM驱动
- **Agent管理器**：负责创建、修改和调用各Agent
- **用户交互界面**：基于命令行的简易交互界面
- **配置管理器**：管理LLM接口及参数配置

## 详细流程

### 1. 系统初始化

1. 加载配置文件（LLM API密钥、模型参数等）
2. 创建并调用 组织者 agent

### 2. 讨论流程控制

主控制器LLM将指导整个讨论流程，通过特定的工具调用实现各环节的功能：

#### 工具定义

1. **assignAgent**
   - 功能：安排新的 agent 或更新已有的 agent
   - 参数：
     - `id`: Agent 的唯一标识
     - `role`: 角色名称
     - `focus`: 关注点/专长
     - `systemPrompt`: 完整的系统提示词
     - `modelConfig`: 模型配置（可选，默认使用系统配置）

2. **invokeAgent**
   - 功能：调用Agent
   - 参数：
     - `id`: Agent 的唯一标识（预设标识：`user`代表用户，`self`代表当前agent自己）
     - `rollover`: true / false，是否开启新一轮（Agent的发言将作为新一轮的第一条）
     - `timeout`: 超时时间（可选，默认使用系统配置），等待用户反馈环节可以设置较长等待
     - `prompt`: 提示词（可选，默认只使用系统提示词）

### 3. 讨论流程

使用基于Hand-over机制的单一大型Prompt控制整个讨论：

#### Hand-over机制设计

1. **讨论参与者**：
   - 组织者(Organizer)：由主控LLM扮演，负责引导、总结和评估
   - 专家(Agents)：各领域专家，以不同参数调用LLM扮演
   - 用户(User)：实际用户，通过阅读和发送信息参与

2. **统一消息流**：
   - 所有发言按时间顺序记录在同一消息链中，直到 invokeAgent 传入 `rollover` 为 true。
   - 消息链作为上下文在参与者间传递（即 hand-over）

#### 实现架构

1. **Bootstrapping**：
   - 调用组织者 Agent 并附上其系统提示词

2. **Agent 调用器**：
   - 根据组织者的 `invokeAgent` 请求调用相应的 Agent
   - 根据 `includeHistory` 参数，传递一定数量的消息历史作为上下文

3. **递归控制机制**：
   - 组织者在每轮末尾进行总结评估
   - 系统询问用户是否继续讨论
   - 若继续，则调用组织者开启新一轮讨论

##### 执行流程

1. 以组织者身份直接输出配置中预置的开场白消息。
   - 开场白消息末尾应带有以下两个调用：
     - `invokeAgent(id='user')` 等待用户输入讨论主题及其它要求（比如每轮的发言次数）。
     - `invokeAgent(id='self')` 进入此轮讨论的规划阶段
2. 组织者 agent 自动按照系统提示词
   - 根据用户的需求，通过一次性输出整个轮次的安排（批量调用 `invokeAgent`）进行规划协调
   - 在安排的末尾 `invokeAgent(id='self')` 再次调用自己进行此轮的总结和评估。
3. 轮次总结和评估输出的末尾，通过 `invokeAgent(id='self', rollover=true)` 启动下一轮
4. 新一轮启动阶段，组织者 agent 按照系统提示词
   - 输出此轮讨论的引导发言，末尾应带有以下两个调用：
     - `invokeAgent(id='user')` 等待用户补充信息，或结束整个头脑风暴（退出程序）
     - `invokeAgent(id='self')` 进入此轮讨论的规划阶段，回到流程第 2 步继续

### 4. 提示词工程

根据以上执行流程，仔细设计并反复打磨相关提示词（确保 LLM 根据提示词执行流程的确定性），保存在 `prompts.md` 文件中。
